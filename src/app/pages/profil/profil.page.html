<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Profil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Memuat profil...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && error" class="error-container">
    <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
    <p>{{ error }}</p>
    <ion-button (click)="loadProfile()" fill="outline" size="small">
      <ion-icon slot="start" name="refresh-outline"></ion-icon>
      Coba Lagi
    </ion-button>
  </div>

  <!-- Profile Content -->
  <div *ngIf="!isLoading && !error && profile" class="profile-container">
    <!-- Header Card with Avatar -->
    <div class="profile-header">
      <div class="avatar-container">
        <ion-avatar class="profile-avatar">
          <img [src]="getAvatarUrl()" [alt]="getDisplayName()" />
        </ion-avatar>
      </div>
      <h1 class="profile-name">{{ getDisplayName() }}</h1>
      <ion-chip color="primary" class="role-chip">
        <ion-label>{{ getRoleText() }}</ion-label>
      </ion-chip>
    </div>

    <!-- Account Information Card -->
    <ion-card class="info-card">
      <ion-card-header>
        <ion-card-title>Informasi Akun</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item>
            <ion-icon
              name="person-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Username</p>
              <h3>{{ profile.username || '-' }}</h3>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon
              name="mail-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Email</p>
              <h3>{{ profile.email || '-' }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Siswa Specific Information -->
    <ion-card
      *ngIf="profile.role === 'siswa' && profile.siswa"
      class="info-card"
    >
      <ion-card-header>
        <ion-card-title>Data Siswa</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="profile.siswa.nis">
            <ion-icon
              name="card-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">NIS</p>
              <h3>{{ profile.siswa.nis }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.siswa.kelas">
            <ion-icon
              name="school-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Kelas</p>
              <h3>
                {{ profile.siswa.kelas.nama }}
                <span *ngIf="profile.siswa.kelas.ruangan"
                  >- {{ profile.siswa.kelas.ruangan }}</span
                >
              </h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.siswa.jenis_kelamin_text">
            <ion-icon
              name="person-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Jenis Kelamin</p>
              <h3>{{ profile.siswa.jenis_kelamin_text }}</h3>
            </ion-label>
          </ion-item>
          <ion-item
            *ngIf="profile.siswa.tempat_lahir || profile.siswa.tanggal_lahir"
          >
            <ion-icon
              name="calendar-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Tempat, Tanggal Lahir</p>
              <h3>
                {{ profile.siswa.tempat_lahir || '-' }}, {{
                formatDate(profile.siswa.tanggal_lahir) }}
              </h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.siswa.alamat">
            <ion-icon
              name="location-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Alamat</p>
              <h3>{{ profile.siswa.alamat }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.siswa.no_hp">
            <ion-icon
              name="call-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">No. HP</p>
              <h3>{{ profile.siswa.no_hp }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.siswa.tahun_masuk">
            <ion-icon
              name="calendar-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Tahun Masuk</p>
              <h3>{{ profile.siswa.tahun_masuk }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Guru Specific Information -->
    <ion-card
      *ngIf="(profile.role === 'guru' || profile.role === 'wali-kelas' || profile.role === 'kepala-sekolah') && profile.guru"
      class="info-card"
    >
      <ion-card-header>
        <ion-card-title>Data {{ getRoleText() }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="profile.guru.nip">
            <ion-icon
              name="card-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">NIP</p>
              <h3>{{ profile.guru.nip }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.guru.jenis_kelamin_text">
            <ion-icon
              name="person-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Jenis Kelamin</p>
              <h3>{{ profile.guru.jenis_kelamin_text }}</h3>
            </ion-label>
          </ion-item>
          <ion-item
            *ngIf="profile.guru.tempat_lahir || profile.guru.tanggal_lahir"
          >
            <ion-icon
              name="calendar-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Tempat, Tanggal Lahir</p>
              <h3>
                {{ profile.guru.tempat_lahir || '-' }}, {{
                formatDate(profile.guru.tanggal_lahir) }}
              </h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.guru.alamat">
            <ion-icon
              name="location-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Alamat</p>
              <h3>{{ profile.guru.alamat }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.guru.no_hp">
            <ion-icon
              name="call-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">No. HP</p>
              <h3>{{ profile.guru.no_hp }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Orang Tua Specific Information -->
    <ion-card
      *ngIf="profile.role === 'orang-tua' && profile.orang_tua"
      class="info-card"
    >
      <ion-card-header>
        <ion-card-title>Data Orang Tua</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngIf="profile.orang_tua.jenis_kelamin_text">
            <ion-icon
              name="person-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Jenis Kelamin</p>
              <h3>{{ profile.orang_tua.jenis_kelamin_text }}</h3>
            </ion-label>
          </ion-item>
          <ion-item
            *ngIf="profile.orang_tua.tempat_lahir || profile.orang_tua.tanggal_lahir"
          >
            <ion-icon
              name="calendar-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Tempat, Tanggal Lahir</p>
              <h3>
                {{ profile.orang_tua.tempat_lahir || '-' }}, {{
                formatDate(profile.orang_tua.tanggal_lahir) }}
              </h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.orang_tua.alamat">
            <ion-icon
              name="location-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Alamat</p>
              <h3>{{ profile.orang_tua.alamat }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.orang_tua.no_hp">
            <ion-icon
              name="call-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">No. HP</p>
              <h3>{{ profile.orang_tua.no_hp }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.orang_tua.pendidikan">
            <ion-icon
              name="school-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Pendidikan</p>
              <h3>{{ profile.orang_tua.pendidikan }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.orang_tua.pekerjaan">
            <ion-icon
              name="briefcase-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Pekerjaan</p>
              <h3>{{ profile.orang_tua.pekerjaan }}</h3>
            </ion-label>
          </ion-item>
          <ion-item *ngIf="profile.orang_tua.penghasilan_formatted">
            <ion-icon
              name="cash-outline"
              slot="start"
              color="primary"
            ></ion-icon>
            <ion-label>
              <p class="label-text">Penghasilan</p>
              <h3>{{ profile.orang_tua.penghasilan_formatted }}</h3>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Logout Button -->
    <div class="logout-section">
      <ion-button expand="block" color="danger" (click)="logout()">
        <ion-icon slot="start" name="log-out-outline"></ion-icon>
        Logout
      </ion-button>
    </div>
  </div>
</ion-content>
